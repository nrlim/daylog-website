// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  email     String?  @unique
  role      String   @default("member") // admin, member
  points    Int      @default(0)         // User's total points
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  teamMembers         TeamMember[]
  activities          Activity[]
  votes               Vote[]
  wfhRecords          WFHRecord[]
  wfhQuotas           UserWFHQuota[]
  pointTransactions   PointTransaction[]
  adminPointTransactions PointTransaction[] @relation("adminPointTransactions")
  redemptions         Redemption[]
}

model Team {
  id                  String   @id @default(uuid())
  name                String
  description         String?
  wfhLimitPerMonth    Int      @default(3) // Work from home limit per month
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  members             TeamMember[]
  pokerSessions       PokerSession[]
  wfhRecords          WFHRecord[]
}

model TeamMember {
  id        String   @id @default(uuid())
  userId    String
  teamId    String
  role      String   @default("member") // team_admin, member
  isLead    Boolean  @default(false)    // Is this member a team lead?
  joinedAt  DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@unique([userId, teamId])
}

model Activity {
  id            String   @id @default(uuid())
  userId        String
  date          DateTime
  time          String?  // Time in HH:MM format
  subject       String   // Subject/title of the activity
  description   String   // Detailed description
  status        String   // Done, InProgress, Blocked
  blockedReason String?  // Reason why activity is blocked
  isWfh         Boolean  @default(false) // Work from home flag
  project       String?  // Project name (MZA, ZSMART, CIRRUST, etc.)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model WFHRecord {
  id        String   @id @default(uuid())
  userId    String
  teamId    String
  date      DateTime // The date of WFH activity
  month     Int      // Month (1-12)
  year      Int      // Year
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@unique([userId, teamId, date])
}

model PokerSession {
  id          String   @id @default(uuid())
  teamId      String
  storyName   String
  description String?
  status      String   @default("voting") // voting, revealed, completed
  finalPoints Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  team  Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  votes Vote[]
}

model Vote {
  id              String   @id @default(uuid())
  pokerSessionId  String
  userId          String
  points          Int
  createdAt       DateTime @default(now())
  
  session PokerSession @relation(fields: [pokerSessionId], references: [id], onDelete: Cascade)
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([pokerSessionId, userId])
}

model AnonymousPokerSession {
  id          String   @id
  creatorName String
  participants Json     // Store as JSON array of {name, card, revealed}
  showResults Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PointTransaction {
  id          String   @id @default(uuid())
  userId      String
  adminId     String
  points      Int
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  admin User @relation("adminPointTransactions", fields: [adminId], references: [id], onDelete: Cascade)
}
model Reward {
  id          String   @id @default(uuid())
  name        String
  description String?
  pointsCost  Int      // Points required to redeem
  quantity    Int      @default(-1)  // -1 means unlimited
  isActive    Boolean  @default(true)
  expiresAt   DateTime?               // When this reward expires (null = no expiration)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  redemptions Redemption[]
}

model Redemption {
  id        String   @id @default(uuid())
  userId    String
  rewardId  String
  status    String   @default("pending") // pending, approved, rejected, completed, expired
  isActivated Boolean @default(false)   // For WFH rewards: whether user has activated it for current month
  activatedAt DateTime?                 // When the reward was activated
  expiresAt DateTime?                   // When this redemption expires (null = uses reward's expiration)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  reward Reward @relation(fields: [rewardId], references: [id], onDelete: Cascade)
}

model UserWFHQuota {
  id        String   @id @default(uuid())
  userId    String
  month     Int      // 1-12
  year      Int      // YYYY
  totalQuota Int     @default(0)  // Total personal WFH quota for this month (from rewards)
  usedDays  Int      @default(0)  // How many personal WFH days used this month
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, month, year])
}